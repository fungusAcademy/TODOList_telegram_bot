# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      uses: appleboy/ssh-action@v1.0.0
      with:
        script: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install alembic psycopg2-binary

    - name: Run migrations on production
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        alembic upgrade head

    - name: Run tests
      run: pytest -v

    - name: Restart Bot
      run: |
        # Restart the bot process
        if [ -f bot.pid ]; then
          kill $(cat bot.pid) 2>/dev/null || true
          sleep 2
        fi

        # Start the bot and save PID
        nohup python main.py > bot.log 2>&1 &
        echo $! > bot.pid
        
        echo "Deployment completed successfully!"

    - name: Trigger Render deployment
      run: |
        # Для автоматического деплоя на Render при пуше в main
        # Render автоматически обнаружит push и запустит деплой
        echo "Deployment triggered by push to main branch"

    # - name: Send Telegram notification
    #   if: success()
    #   uses: appleboy/telegram-action@v1.0.0
    #   with:
    #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
    #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #     message: |
    #       ✅ Deployment Successful!
    #       Branch: ${{ github.ref }}
    #       Commit: ${{ github.sha }}
    #       By: ${{ github.actor }}

    # - name: Send failure notification
    #   if: failure()
    #   uses: appleboy/telegram-action@v1.0.0
    #   with:
    #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
    #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #     message: |
    #       ❌ Deployment Failed!
    #       Branch: ${{ github.ref }}
    #       Commit: ${{ github.sha }}
    #       By: ${{ github.actor }}